---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import Link from '@components/atoms/Link.astro'
import Tag from '@components/atoms/Tag.astro';
import HeroSection from '@components/sections/HeroSection.astro';
import PageLayout from '@layouts/PageLayout.astro';
import SectionLayout from '@layouts/SectionLayout.astro';
import { isDev } from '@utils/dev';

export async function getStaticPaths() {
  const posts = await getCollection('blog');

  // In production, only build published posts. In dev, build all posts.
  return posts
    .filter((post) => isDev || post.data.published === 'published')
    .map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Fetch all people for author lookups
const allPeople = await getCollection('people');
const peopleMap = new Map(allPeople.map((person) => [person.data.id, person.data]));

// Get author details
const authors = post.data.authors
  .map((id) => peopleMap.get(id))
  .filter(Boolean);

// Get related posts
const allPosts = await getCollection('blog');
const relatedPosts = post.data.relatedPosts
  ? post.data.relatedPosts
      .filter(permalink => permalink !== post.data.permalink) // Don't show current post
      .map((permalink) => {
        const relatedPost = allPosts.find(
          (p) => p.data.permalink === permalink && (isDev || p.data.published === 'published')
        );
        if (!relatedPost) {
          console.warn(`Related post not found: ${permalink}`);
          return null;
        }

        // Resolve authors for the related post
        const relatedAuthors = relatedPost.data.authors
          .map((id) => peopleMap.get(id))
          .filter(Boolean);

        return {
          ...relatedPost,
          resolvedAuthors: relatedAuthors
        };
      })
      .filter((post): post is NonNullable<typeof post> => post !== null)
  : [];

// Format date
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
};

const {title, publishedDate, heroImage, tags, published } = post.data
---

<PageLayout
	title={post.data.title}
	description={`Blog post by ${authors.map((a) => a?.name).join(', ')}`}
	image={heroImage}
>
	<!-- Post Header -->
	<SectionLayout bgImage={heroImage} sectionLabel="hero">
		<HeroSection title={title}>
			{/* Draft badge (only visible in dev) */}
			{
				isDev && published === 'draft' && (
					<div class="mb-4">
						<Tag variant="highlight" size="md" class="font-bold">
							DRAFT
						</Tag>
					</div>
				)
			}
			{/* Tags */}
			<div class="mb-4 flex flex-wrap gap-2">
				{
					tags.map((tag) => (
						<Tag variant="primary" size="md">
							{tag}
						</Tag>
					))
				}
			</div>

			{/* Metadata */}
			<div class="flex flex-wrap items-center gap-4 text-gray-700">
				<p class="text-base">
					By <span class="font-medium"
						>{
							authors.map((a, i) => (
								<>
									<Link variant="unstyled" href={`/people/${a?.id}`}>
										{a?.name}
									</Link>
									{i < authors.length - 1 && '•'}
								</>
							))
						}</span
					>
				</p>
				<span class="text-gray-400">•</span>
				<p class="text-base">
					{formatDate(publishedDate)}
				</p>
			</div>
		</HeroSection>
	</SectionLayout>

	<!-- Post Content -->
	<SectionLayout>
		<article class="mx-auto prose max-w-4xl py-12 prose-blue">
			<Content />
		</article>
	</SectionLayout>

	<!-- Related Posts Section -->
	{
		relatedPosts.length > 0 && (
			<SectionLayout bgColor="gray">
				<div class="mx-auto max-w-4xl py-12">
					<h2 class="mb-8 text-2xl font-bold">Related Posts</h2>
					<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
						{relatedPosts.map((relatedPost) => (
							<Link
								variant="unstyled"
								href={`/blog/${relatedPost.slug}`}
								class="flex flex-col overflow-hidden rounded-lg bg-white no-underline transition hover:shadow-lg"
							>
								{/* Hero Image */}
								{relatedPost.data.heroImage && (
									<Image
										src={relatedPost.data.heroImage}
										alt={relatedPost.data.title}
										class="h-48 w-full object-cover"
									/>
								)}

								{/* Card Content */}
								<div class="flex flex-col gap-3 p-6">
									{/* Tags */}
									<div class="flex flex-wrap gap-2">
										{relatedPost.data.tags.slice(0, 2).map((tag) => (
											<Tag variant="primary" size="sm">
												{tag}
											</Tag>
										))}
									</div>

									{/* Title */}
									<h3 class="line-clamp-2 text-lg font-semibold">
										{relatedPost.data.title}
									</h3>

									{/* Metadata: Authors and Date */}
									<div class="mt-auto text-sm text-gray-600">
										<p>
											By{' '}
											{relatedPost.resolvedAuthors.map((a, i) => (
												<>
													{a?.name}
													{i < relatedPost.resolvedAuthors.length - 1 &&
														', '}
												</>
											))}
										</p>
										<p class="mt-1 text-xs text-gray-500">
											{formatDate(relatedPost.data.publishedDate)}
										</p>
									</div>
								</div>
							</Link>
						))}
					</div>
				</div>
			</SectionLayout>
		)
	}

	<!-- Authors Section -->
	{
		authors && (
			<SectionLayout bgColor="bg-gray-50">
				<div class="mx-auto max-w-4xl py-12">
					<h2 class="mb-8 text-2xl font-bold">
						{authors.length === 1 ? 'About the Author' : 'About the Authors'}
					</h2>
					<div class="grid gap-6 md:grid-cols-2">
						{authors.map(
							(author) =>
								author && (
									<Link
										variant="unstyled"
										href={`/people/${author.id}`}
										class="flex gap-4 rounded-lg bg-white p-6 no-underline transition hover:shadow-sm"
									>
										{author.headshot && (
											<Image
												src={author.headshot}
												alt={author.name}
												class="h-16 w-16 rounded-full object-cover"
											/>
										)}

										<div>
											<h3 class="mb-1 text-lg font-semibold">{author.name}</h3>
											<p class="text-sm text-gray-600">{author.title}</p>
										</div>
									</Link>
								)
						)}
					</div>
				</div>
			</SectionLayout>
		)
	}
</PageLayout>
