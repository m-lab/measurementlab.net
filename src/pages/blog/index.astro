---
import { getCollection } from 'astro:content';
import housesBG from '@assets/backgrounds/anna-magenta-XUCfqIEudBU-unsplash.jpg'
import LogoBlue from '@assets/logo-short-blue.svg'
import MlabDefault from '@assets/mlab-default-card.png'
import Button from '@components/atoms/Button.astro';
import Image from '@components/atoms/Image.astro';
import Tag from '@components/atoms/Tag.astro';
import Card from '@components/molecules/Card.astro';
import HouseCard from '@components/molecules/HouseCard.astro';
import HeroSection from '@components/sections/HeroSection.astro';
import PageLayout from '@layouts/PageLayout.astro';
import SectionLayout from '@layouts/SectionLayout.astro';
import { isDev } from '@utils/dev';


// Fetch all blog posts
const allPosts = await getCollection('blog');

// Filter posts based on environment: show drafts in dev, only published in production
const posts = allPosts
  .filter((post) => isDev || post.data.published === 'published')
  .sort((a, b) => b.data.publishedDate.getTime() - a.data.publishedDate.getTime());

// Fetch all people for author lookups
const allPeople = await getCollection('people');
const peopleMap = new Map(allPeople.map((person) => [person.data.id, person.data]));

// Helper to get author names
const getAuthorNames = (authorIds: string[]) => {
  return authorIds
    .map((id) => peopleMap.get(id)?.name)
    .filter(Boolean)
    .join(', ');
};

// Helper to format date
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
};
---

<PageLayout
	title="Blog"
	description="Explore our latest blog posts on measurement, research, and open data"
>
	<!-- Header Section -->
	<SectionLayout bgImage={housesBG} sectionLabel="hero">
		<HeroSection
			title="Blog"
			subtitle="Insights, research, and updates from the M-Lab team"
		/>
	</SectionLayout>

	<!-- Blog Posts Grid -->
	<SectionLayout>
		<div class="py-12">
			{
				posts.length === 0 ? (
					<div class="py-12 text-center">
						<p class="text-gray-600 text-lg">
							No blog posts published yet. Check back soon!
						</p>
					</div>
				) : (
					<div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
						{posts.map((post) => (
							<HouseCard
								variant="primary"
								title={post.data.title}
								description={post.data.excerpt}
								class="flex h-full flex-col"
								image={post.data.heroImage || MlabDefault}
								href={`/blog/${post.slug}`}
							>
								<div class="flex flex-col">
									{/* Draft badge (only visible in dev) */}
									{isDev && post.data.published === 'draft' && (
										<div class="mb-3">
											<Tag variant="highlight" class="font-bold">
												DRAFT
											</Tag>
										</div>
									)}

									{/* Tags */}
									<div class="mb-3 flex flex-wrap gap-2">
										{post.data.tags.slice(0, 3).map((tag) => (
											<Tag variant="primary">{tag}</Tag>
										))}
									</div>

									{/* Metadata */}
									<div class="mb-4 space-y-1">
										<p class="">By {getAuthorNames(post.data.authors)}</p>
										<p class="">{formatDate(post.data.publishedDate)}</p>
									</div>
								</div>
							</HouseCard>
						))}
					</div>
				)
			}
		</div>
	</SectionLayout>
</PageLayout>
