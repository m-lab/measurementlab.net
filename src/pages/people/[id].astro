---
import { getCollection } from 'astro:content';
import MlabDefault from '@assets/mlab-default-card.png';
import Image from '@components/atoms/Image.astro';
import Tag from '@components/atoms/Tag.astro';
import HouseCard from '@components/molecules/HouseCard.astro';
import Hero from '@components/organisms/Hero.astro';
import PageLayout from '@layouts/PageLayout.astro';
import SectionLayout from '@layouts/SectionLayout.astro';
import { siteConfig } from '@lib/config';
import type { GetStaticPaths } from 'astro';

// Generate static paths for all people
export const getStaticPaths = (async () => {
  const peopleEntries = await getCollection('people');
  return peopleEntries.map((entry) => ({
    params: { id: entry.data.id },
    props: { person: entry.data },
  }));
}) satisfies GetStaticPaths;

const { person } = Astro.props;

//  Get Site data


// Get publications this person contributed to
const allPublications = await getCollection('publications');
const personPublications = allPublications
  .filter((pub) => pub.data.contributors?.includes(person.id))
  .sort((a, b) => b.data.year - a.data.year);

// Get blog posts this person authored
const allBlogPosts = await getCollection('blog');
const personBlogPosts = allBlogPosts
  .filter((post) => post.data.authors?.includes(person.id))
  .sort((a, b) => b.data.publishedDate.getTime() - a.data.publishedDate.getTime());

// Fetch all people for author lookups
const allPeople = await getCollection('people');
const peopleMap = new Map(allPeople.map((person) => [person.data.id, person.data]));

// Helper to get author names
const getAuthorNames = (authorIds: string[]) => {
  return authorIds
    .map((id) => peopleMap.get(id)?.name)
    .filter(Boolean)
    .join(', ');
};

// Helper to format date
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
};
---

<PageLayout
	title={`${person.name}`}
	description={`${person.name}, ${person.title}`}
	image={person.headshot}
>
	<!-- Hero Section -->
	<SectionLayout zigzag="primary-light" maxWidth="2xl">
		<HouseCard>
			<!-- Person Details -->
			<div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
				<div class="flex flex-col items-center text-center">
					<!-- Headshot -->
					<div class="mb-8">
						<Image
							src={person.headshot}
							alt={person.name}
							width={300}
							height={300}
							class="h-64 w-64 rounded-lg object-cover shadow-lg"
						/>
					</div>

					<!-- Name -->
					<h2 class="mb-4">
						{person.name}
					</h2>

					<!-- Title -->
					<p class="text-gray-600 mb-6">
						{person.title}
					</p>
				</div>
			</div>
		</HouseCard>
	</SectionLayout>
	<!-- Sections/Departments -->
	<!-- {
		person.sections && person.sections.length > 0 && (
			<section class="bg-gray-50 py-16">
				<div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
					<h2 class="mb-8 text-center">Departments</h2>
					<div class="flex flex-wrap justify-center gap-2">
						{person.sections.map((section) => (
							<span class="rounded-full bg-primary-100 px-4 py-2 text-primary-700">
								{section}
							</span>
						))}
					</div>
				</div>
			</section>
		)
	} -->

	<!-- Publications Section -->
	{
		personPublications.length > 0 && (
			<section class="bg-gray-50 py-16">
				<div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
					<h2 class="mb-8 text-center">Publications</h2>
					<div class="space-y-6">
						{personPublications.map((pub) => (
							<article class="rounded-lg bg-white p-6 shadow-md">
								<div class="mb-2 flex items-start justify-between gap-4">
									<h3 class="text-gray-900 text-xl font-semibold">
										{pub.data.title}
									</h3>
									<span class="shrink-0 rounded-full bg-primary-100 px-3 py-1 text-sm font-medium text-primary-700">
										{pub.data.year}
									</span>
								</div>

								{pub.data.authors && (
									<p class="text-gray-600 mb-2 text-sm">{pub.data.authors}</p>
								)}

								{pub.data.description && (
									<p class="text-gray-700 mb-4 line-clamp-3">
										{pub.data.description}
									</p>
								)}

								{pub.data.venue && (
									<p class="text-gray-500 mb-3 text-sm italic">
										{pub.data.venue}
									</p>
								)}

								<div class="flex flex-wrap gap-2">
									{pub.data.internalLinks?.map((link) => (
										<a
											href={`/src/assets/${link.path}`}
											class="text-sm text-primary-600 hover:text-primary-700 hover:underline"
										>
											{link.label}
										</a>
									))}
									{pub.data.externalLinks?.map((link) => (
										<a
											href={link.url}
											target="_blank"
											rel="noopener noreferrer"
											class="text-sm text-primary-600 hover:text-primary-700 hover:underline"
										>
											{link.label} â†—
										</a>
									))}
									{pub.data.videoLinks?.map((link) => (
										<a
											href={link.url}
											target="_blank"
											rel="noopener noreferrer"
											class="text-sm text-primary-600 hover:text-primary-700 hover:underline"
										>
											{link.label} ğŸ¥
										</a>
									))}
								</div>
							</article>
						))}
					</div>
				</div>
			</section>
		)
	}

	<!-- Blog Posts Section -->
	{
		personBlogPosts.length > 0 && (
			<section class="py-16">
				<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
					<h2 class="mb-8 text-center">Blog Posts</h2>
					<div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
						{personBlogPosts.map((post) => (
							<HouseCard
								variant="primary"
								title={post.data.title}
								description={post.data.excerpt}
								class="flex h-full flex-col"
								image={post.data.heroImage || MlabDefault}
								href={`/blog/${post.slug}`}
							>
								<div class="flex flex-col">
									{/* Tags */}
									<div class="mb-3 flex flex-wrap gap-2">
										{post.data.tags?.slice(0, 3).map((tag) => (
											<Tag variant="primary">{tag}</Tag>
										))}
									</div>

									{/* Metadata */}
									<div class="mb-4 space-y-1">
										<p class="">By {getAuthorNames(post.data.authors)}</p>
										<p class="">{formatDate(post.data.publishedDate)}</p>
									</div>
								</div>
							</HouseCard>
						))}
					</div>
				</div>
			</section>
		)
	}

	<!-- Back Button -->
	<section class="pb-16">
		<div class="mx-auto max-w-4xl px-4 text-center sm:px-6 lg:px-8">
			<a onclick="history.back()" class="default-link cursor-pointer">
				â† Back
			</a>
		</div>
	</section>
</PageLayout>
